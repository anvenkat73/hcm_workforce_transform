 SELECT  CDD.MANAGER_ASSIGNMENT_ID AS MANAGER_ASSIGNMENT_ID , 
  GLF.ASSIGNMENT_ID AS ASSIGNMENT_ID         , 
  GLF.EVENT_DATE AS EVENT_DATE            , 
  GLF.EVENT_ID AS EVENT_ID              , 
  CAST(CDD.MANAGER_ASSIGNMENT_ID AS STRING)||'~'||CAST(GLF.ASSIGNMENT_ID AS STRING)||'~'||FORMAT_DATE('%Y%m%d', PARSE_DATE('%Y-%m-%d', GLF.EVENT_DATE)||'~'||FORMAT_DATE('%Y%m%d', PARSE_DATE('%Y-%m-%d',GLF.EVENT_ID)) AS SOURCE_RECORD_ID      , 
  CASE WHEN SUM(GLF.NET_GAIN_LOSS_IND) = 0 THEN 1 ELSE 0 END AS HRCHY_CHNG_WTHN_IND   
 FROM  {{ ref('DW_WRKFRC_GAIN_LOSS_ASG_F') }} GLF 
 INNER JOIN {{ ref('DW_MANAGER_REPORTEES_CF_DN_DH') }} CDD  ON (CDD.LEVEL20_REPORTEE_ASSIGNMENT_ID=GLF.ASSIGNMENT_ID AND PARSE_DATE('%Y-%m-%d',GLF.GAIN_LOSS_DATE) BETWEEN PARSE_DATE('%Y-%m-%d',CDD.EFFECTIVE_START_DATE) AND  PARSE_DATE('%Y-%m-%d',CDD.EFFECTIVE_END_DATE)) AND CDD.MANAGER_DISTANCE <> 0
 GROUP BY  CDD.MANAGER_ASSIGNMENT_ID, GLF.ASSIGNMENT_ID, GLF.EVENT_DATE, GLF.EVENT_ID, CAST(CDD.MANAGER_ASSIGNMENT_ID AS STRING)||'~'||CAST(GLF.ASSIGNMENT_ID AS STRING)||'~'||PARSE_DATE('%Y-%m-%d',GLF.EVENT_DATE)||'~'||CAST(GLF.EVENT_ID AS STRING)
