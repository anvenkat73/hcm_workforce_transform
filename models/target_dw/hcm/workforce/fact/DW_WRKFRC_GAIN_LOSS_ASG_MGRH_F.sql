 SELECT   CDD3.MANAGER_ASSIGNMENT_ID AS MANAGER_ASSIGNMENT_ID            , 
   ASG_GL2.ASSIGNMENT_ID AS ASSIGNMENT_ID                    , 
   ASG_GL2.EVENT_DATE AS EVENT_DATE                        , 
   ASG_GL2.EVENT_ID AS EVENT_ID                        , 
   ASG_GL2.NET_GAIN_LOSS_IND AS NET_GAIN_LOSS_IND                , 
   CAST(CHNG_STG.MANAGER_ASSIGNMENT_ID AS STRING) ||'~'||CAST(ASG_GL2.ASSIGNMENT_ID AS STRING) ||'~'||FORMAT_DATE('%Y%m%d',  PARSE_DATE('%Y-%m-%d',ASG_GL2.EVENT_DATE))||'~'||CAST(ASG_GL2.EVENT_ID AS STRING)||'~'||CAST(ASG_GL2.NET_GAIN_LOSS_IND AS STRING) AS SOURCE_RECORD_ID                , 
   CDD3.MANAGER_ID AS MANAGER_ID                      , 
   ASG_GL2.GAIN_IND AS GAIN_IND                        , 
   ASG_GL2.LOSS_IND AS LOSS_IND                        , 
   0 AS HRCHY_IN_OUT_IND                , 
   CHNG_STG.HRCHY_CHNG_WTHN_IND AS HRCHY_CHNG_WTHN_IND                , 
   ASG_GL2.GAIN_LOSS_DATE AS GAIN_LOSS_DATE                    , 
   ASG_GL2.ACTION_TYPE_CODE AS ACTION_TYPE_CODE                , 
   ASG_GL2.ACTION_ID AS ACTION_ID                        , 
   ASG_GL2.ACTION_REASON_ID AS ACTION_REASON_ID                , 
   ASG_GL2.ACTION_META_REASON_CODE AS ACTION_META_REASON_CODE            , 
   ASG_GL2.SUPERVISOR_ID AS SUPERVISOR_ID                    , 
   ASG_GL2.JOB_ID AS JOB_ID                            , 
   ASG_GL2.DEPARTMENT_ID AS DEPARTMENT_ID                    , 
   ASG_GL2.PERSON_ID AS PERSON_ID                        , 
   ASG_GL2.LOCATION_ID AS LOCATION_ID                        , 
   ASG_GL2.POSITION_ID AS POSITION_ID                        , 
   ASG_GL2.GRADE_ID AS GRADE_ID                        , 
   ASG_GL2.SUPERVISOR_ASSIGNMENT_ID AS SUPERVISOR_ASSIGNMENT_ID        , 
   ASG_GL2.LEGAL_EMPLOYER_ID AS LEGAL_EMPLOYER_ID                , 
   ASG_GL2.BUSINESS_UNIT_ID AS BUSINESS_UNIT_ID                , 
   ASG_GL2.REPORTING_ESTABLISHMENT_ID AS REPORTING_ESTABLISHMENT_ID        , 
   ASG_GL2.PERIOD_OF_SERVICE_ID AS PERIOD_OF_SERVICE_ID            , 
   ASG_GL2.PERSON_TYPE_ID AS PERSON_TYPE_ID                    , 
   ASG_GL2.SYSTEM_PERSON_TYPE AS SYSTEM_PERSON_TYPE                , 
   ASG_GL2.WORKER_TYPE AS WORKER_TYPE                        , 
   ASG_GL2.LEGISLATION_CODE AS LEGISLATION_CODE                , 
   ASG_GL2.ASSIGNMENT_CATEGORY AS ASSIGNMENT_CATEGORY                , 
   ASG_GL2.ASSIGNMENT_STATUS_TYPE_ID AS ASSIGNMENT_STATUS_TYPE_ID        , 
   ASG_GL2.PAY_SYSTEM_STATUS AS PAY_SYSTEM_STATUS                , 
   ASG_GL2.PER_SYSTEM_STATUS AS PER_SYSTEM_STATUS                , 
   ASG_GL2.WORKER_CATEGORY AS WORKER_CATEGORY                    , 
   ASG_GL2.FULL_PART_TIME_FLAG AS FULL_PART_TIME_FLAG                , 
   ASG_GL2.AGE_IN_YEARS AS AGE_IN_YEARS                    , 
   ASG_GL2.TENURE_IN_YEARS AS TENURE_IN_YEARS                    , 
   ASG_GL2.AGE_IN_MONTHS AS AGE_IN_MONTHS                    , 
   ASG_GL2.TENURE_IN_MONTHS AS TENURE_IN_MONTHS                , 
   ASG_GL2.ASSIGNMENT_NUMBER AS ASSIGNMENT_NUMBER                , 
   ASG_GL2.ASSIGNMENT_NAME AS ASSIGNMENT_NAME                 , 
   ASG_GL2.PRIMARY_FLAG AS PRIMARY_FLAG                    , 
   ASG_GL2.PRIMARY_ASSIGNMENT_FLAG AS PRIMARY_ASSIGNMENT_FLAG            , 
   ASG_GL2.HEADCOUNT AS EVENT_HEADCOUNT                    , 
   ASG_GL2.FTE AS EVENT_FTE                        , 
   ASG_GL2.EVENT_ASG_COUNT AS EVENT_ASG_COUNT                    , 
   ASG_GL2.JOB_GAIN_LOSS_IND AS JOB_GAIN_LOSS_IND                , 
   ASG_GL2.GRADE_GAIN_LOSS_IND AS GRADE_GAIN_LOSS_IND                , 
   ASG_GL2.LOCATION_GAIN_LOSS_IND AS LOCATION_GAIN_LOSS_IND            , 
   ASG_GL2.POSITION_GAIN_LOSS_IND AS POSITION_GAIN_LOSS_IND            , 
   ASG_GL2.DEPARTMENT_GAIN_LOSS_IND AS DEPARTMENT_GAIN_LOSS_IND        , 
   ASG_GL2.SUPERVISOR_GAIN_LOSS_IND AS SUPERVISOR_GAIN_LOSS_IND        , 
   ASG_GL2.BUSINESS_UNIT_GAIN_LOSS_IND AS BUSINESS_UNIT_GAIN_LOSS_IND        , 
       ASG_GL2.FULL_PART_TIME_GAIN_LOSS_IND AS FULL_PART_TIME_GAIN_LOSS_IND    , 
       ASG_GL2.HIRE_EVENT_IND AS HIRE_EVENT_IND                    , 
       ASG_GL2.REHIRE_EVENT_IND AS REHIRE_EVENT_IND                , 
       ASG_GL2.TERM_EVENT_IND AS TERM_EVENT_IND                    , 
       ASG_GL2.GLB_TRANSFER_IN_IND AS GLB_TRANSFER_IN_IND                , 
       ASG_GL2.GLB_TRANSFER_OUT_IND AS GLB_TRANSFER_OUT_IND            , 
   ASG_GL2.GLB_TEMP_TRANSFER_IN_IND AS GLB_TEMP_TRANSFER_IN_IND        , 
   ASG_GL2.GLB_TEMP_TRANSFER_OUT_IND AS GLB_TEMP_TRANSFER_OUT_IND        , 
   ASG_GL2.TRANSFER_EVENT_IND AS TRANSFER_EVENT_IND                , 
   ASG_GL2.PROMOTION_EVENT_IND AS PROMOTION_EVENT_IND                , 
   ASG_GL2.REORG_EVENT_IND AS REORG_EVENT_IND                    , 
   ASG_GL2.OTHER_EVENT_IND AS OTHER_EVENT_IND                    , 
   0 AS DRVD_MGR_GAIN_LOSS_IND            
 FROM  {{ ref('DW_WRKFRC_GAIN_LOSS_ASG_F') }} ASG_GL2 
 INNER JOIN {{ ref('DW_MANAGER_REPORTEES_CF_DN_DH') }} CDD3  ON ( ASG_GL2.ASSIGNMENT_ID = CDD3.LEVEL20_REPORTEE_ASSIGNMENT_ID 
 AND ASG_GL2.GAIN_LOSS_DATE BETWEEN CDD3.EFFECTIVE_START_DATE AND CDD3.EFFECTIVE_END_DATE ) 
 AND CDD3.MANAGER_DISTANCE <> 0 
 INNER JOIN  {{ ref('DW_WRKFRC_ASG_MGRH_CHNG_STAGE') }} CHNG_STG  ON (CDD3.MANAGER_ASSIGNMENT_ID = CHNG_STG.MANAGER_ASSIGNMENT_ID 
 AND ASG_GL2.ASSIGNMENT_ID = CHNG_STG.ASSIGNMENT_ID 
 AND ASG_GL2.EVENT_DATE = CHNG_STG.EVENT_DATE AND ASG_GL2.EVENT_ID = CHNG_STG.EVENT_ID) 
 WHERE  CHNG_STG.HRCHY_CHNG_WTHN_IND = 1
