 SELECT  DW_MANAGER.MANAGER_ASSIGNMENT_ID AS MANAGER_ASSIGNMENT_ID        , 
  DW_MANAGER.MANAGER_ID AS MANAGER_ID                   , 
  ASG_EVT2.EVENT_DATE AS EVENT_DATE                   , 
  ASG_EVT2.MANAGER_IND AS MANAGER_IND                  , 
  DW_MANAGER.MANAGER_DISTANCE AS LEVEL_DISTANCE               , 
  ASG_EVT2.DEPARTMENT_ID AS DEPARTMENT_ID                , 
  ASG_EVT2.JOB_ID AS JOB_ID                       , 
  ASG_EVT2.JOB_FAMILY_ID AS JOB_FAMILY_ID                , 
  ASG_EVT2.LOCATION_ID AS LOCATION_ID                  , 
  ASG_EVT2.POSITION_ID AS POSITION_ID                  , 
  ASG_EVT2.LEGAL_EMPLOYER_ID AS LEGAL_EMPLOYER_ID            , 
  ASG_EVT2.BUSINESS_UNIT_ID AS BUSINESS_UNIT_ID             , 
  ASG_EVT2.ASSIGNMENT_STATUS_TYPE_ID AS ASSIGNMENT_STATUS_TYPE_ID    , 
  ASG_EVT2.WORKER_TYPE AS WORKER_TYPE                  , 
  ASG_EVT2.WORKER_CATEGORY AS WORKER_CATEGORY              , 
  ASG_EVT2.ASSIGNMENT_CATEGORY AS ASSIGNMENT_CATEGORY          , 
  ASG_EVT2.LEGISLATION_CODE AS LEGISLATION_CODE             , 
  ASG_EVT2.COUNTRY AS COUNTRY                      , 
  ASG_EVT2.SEX AS SEX                          , 
  ASG_EVT2.MARITAL_STATUS AS MARITAL_STATUS               , 
  ASG_EVT2.HIGHEST_EDUCATION_LEVEL AS HIGHEST_EDUCATION_LEVEL      , 
  ASG_EVT2.ETHNICITY AS ETHNICITY                    , 
  ASG_EVT2.RELIGION AS RELIGION                     , 
  ASG_EVT2.DISABILITY_FLAG AS DISABILITY_FLAG              , 
  ASG_EVT2.SYSTEM_PERSON_TYPE AS SYSTEM_PERSON_TYPE           , 
  ASG_EVT2.PAY_SYSTEM_STATUS AS PAY_SYSTEM_STATUS            , 
  ASG_EVT2.PER_SYSTEM_STATUS AS PER_SYSTEM_STATUS            , 
  0 AS HEADCOUNT		     , 
  0 AS FTE         		     , 
  0 AS HIRE_EVENT_IND               , 
  0 AS REHIRE_EVENT_IND             , 
  0 AS PROMOTION_EVENT_IND          , 
  0 AS TRANSFER_EVENT_IND           , 
  0 AS TERM_EVENT_IND               , 
  0 AS VOL_TERM_EVENT_IND           , 
  0 AS INVOL_TERM_EVENT_IND         , 
  0 AS GRADE_CHANGE_IND             , 
  0 AS LOCATION_CHANGE_IND          , 
  0 AS POSITION_CHANGE_IND          , 
  0 AS JOB_CHANGE_IND               , 
  0 AS HEADCOUNT_CHANGE_IND         , 
  0 AS FTE_CHANGE_IND               , 
  0 AS MANAGER_CHANGE_IND           , 
  0 AS SALARY_CHANGE_IND            , 
  CASE WHEN ( DENSE_RANK() OVER( PARTITION BY ASG_EVT2.ASSIGNMENT_ID, EVENT_DATE ORDER BY EFFECTIVE_START_DATE DESC) = 2 ) THEN 1 ELSE 0 END AS LEAVE_MANAGER_CHANGE_IND     , 
  CASE WHEN ( DENSE_RANK() OVER( PARTITION BY ASG_EVT2.ASSIGNMENT_ID, EVENT_DATE ORDER BY EFFECTIVE_START_DATE DESC) = 2 ) THEN - 1 ELSE 0 END AS WEIGHTED_MANAGER_CHANGE_IND  
 FROM  {{ ref('DW_WRKFRC_ASG_DAILY_EVENT_F') }} ASG_EVT2 INNER JOIN {{ ref('DW_MANAGER_DN_DH') }} DW_MANAGER  ON ( ASG_EVT2.ASSIGNMENT_ID = DW_MANAGER.ASSIGNMENT_ID AND ASG_EVT2.EVENT_DATE >= DW_MANAGER.EFFECTIVE_START_DATE AND DW_MANAGER.PRIMARY_MANAGER_FLAG = 'Y' AND ASG_EVT2.MANAGER_CHANGE_IND = 1 ) 

