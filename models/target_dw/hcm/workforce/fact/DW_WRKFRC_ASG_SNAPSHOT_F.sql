 SELECT  ASGF.ASSIGNMENT_ID AS ASSIGNMENT_ID , 
 DWD.CALENDAR_DATE AS CALENDAR_DATE , 
 ASGF.ASSIGNMENT_ID||'~'||TO_CHAR(DWD.CALENDAR_DATE,'YYYYMMDD') AS SOURCE_RECORD_ID , 
 ASGF.DEPARTMENT_ID AS DEPARTMENT_ID , 
 ASGF.REPORTING_ESTABLISHMENT_ID AS REPORTING_ESTABLISHMENT_ID, 
  ASGF.JOB_ID AS JOB_ID , 
 JOB.JOB_FAMILY_ID AS JOB_FAMILY_ID, 
  ASGF.LOCATION_ID AS LOCATION_ID , 
 ASGF.POSITION_ID AS POSITION_ID, 
  ASGF.GRADE_ID AS GRADE_ID , 
 COALESCE(RATE_VAL.RATE_VALUE_ID,-99999) AS RATE_VALUE_ID, 
 COALESCE(RATE.RATE_ID,-99999) AS RATE_ID, 
 COALESCE(SAL.SALARY_BASIS_ID,-99999) AS SALARY_BASIS_ID, 
  ASGF.LEGAL_EMPLOYER_ID AS LEGAL_EMPLOYER_ID , 
  ASGF.BUSINESS_UNIT_ID AS BUSINESS_UNIT_ID, 
  ASGF.PERIOD_OF_SERVICE_ID AS PERIOD_OF_SERVICE_ID , 
  ASGF.PERSON_ID AS PERSON_ID , 
  ASGF.PERSON_TYPE_ID AS PERSON_TYPE_ID, 
  ASGF.ASSIGNMENT_STATUS_TYPE_ID AS ASSIGNMENT_STATUS_TYPE_ID, 
  COALESCE(ASG_SUPF.MANAGER_ASSIGNMENT_ID ,-99999) AS MANAGER_ASSIGNMENT_ID, 
 COALESCE(ASG_SUPF.MANAGER_ID,-99999) AS MANAGER_ID , 
 COALESCE(PERF.RATING_LEVEL_ID,-99999) AS PERFORMANCE_RATING_LEVEL_ID, 
 COALESCE(POT.RATING_LEVEL_ID,-99999) AS POTENTIAL_RATING_LEVEL_ID, 
  ASGF.WORKER_TYPE AS WORKER_TYPE , 
  ASGF.WORKER_CATEGORY AS WORKER_CATEGORY, 
  ASGF.ASSIGNMENT_CATEGORY AS ASSIGNMENT_CATEGORY , 
 ASGF.LEGISLATION_CODE AS LEGISLATION_CODE , 
 LOC.COUNTRY AS COUNTRY, 
 PER_LEG.SEX AS SEX, 
 PER_LEG.MARITAL_STATUS AS MARITAL_STATUS, 
 PER_LEG.HIGHEST_EDUCATION_LEVEL AS HIGHEST_EDUCATION_LEVEL, 
 PER_LEG.ETHNICITY AS ETHNICITY, 
 PER_LEG.RELIGION AS RELIGION, 
 PER_LEG.DISABILITY_FLAG AS DISABILITY_FLAG, 
  ASGF.PRIMARY_FLAG AS PRIMARY_FLAG, 
 ASGF.PRIMARY_ASSIGNMENT_FLAG AS PRIMARY_ASSIGNMENT_FLAG, 
 ASGF.ASSIGNMENT_NUMBER AS ASSIGNMENT_NUMBER, 
 ASGF.ASSIGNMENT_NAME AS ASSIGNMENT_NAME, 
  ASGF.SYSTEM_PERSON_TYPE AS SYSTEM_PERSON_TYPE , 
  ASGF.PAY_SYSTEM_STATUS AS PAY_SYSTEM_STATUS, 
  ASGF.PER_SYSTEM_STATUS AS PER_SYSTEM_STATUS, 
 PER_LEG.DATE_OF_BIRTH AS DATE_OF_BIRTH, 
 SPRD.DATE_START AS DATE_START, 
 CASE WHEN DWD.CALENDAR_DATE >= SPRD.ACTUAL_TERMINATION_DATE THEN SPRD.ACTUAL_TERMINATION_DATE ELSE NULL END AS ACTUAL_TERMINATION_DATE, 
 CASE WHEN MGR_STAT.MANAGER_FLAG = 'Y' THEN 1 ELSE 0 END AS MANAGER_IND, 
 TRUNC(MONTHS_BETWEEN(DWD.CALENDAR_DATE,PER_LEG.DATE_OF_BIRTH)/12) AS AGE_IN_YEARS, 
 TRUNC(MONTHS_BETWEEN(DWD.CALENDAR_DATE,PER_LEG.DATE_OF_BIRTH)) AS AGE_IN_MONTHS, 
 CASE WHEN SPRD.ACTUAL_TERMINATION_DATE IS NOT NULL AND SPRD.ACTUAL_TERMINATION_DATE <= DWD.CALENDAR_DATE  THEN TRUNC(MONTHS_BETWEEN(SPRD.ACTUAL_TERMINATION_DATE , SPRD.DATE_START)/12) ELSE  TRUNC(MONTHS_BETWEEN(DWD.CALENDAR_DATE , SPRD.DATE_START)/12) END AS TENURE_IN_YEARS, 
 CASE WHEN SPRD.ACTUAL_TERMINATION_DATE IS NOT NULL AND SPRD.ACTUAL_TERMINATION_DATE <= DWD.CALENDAR_DATE  THEN TRUNC(MONTHS_BETWEEN(SPRD.ACTUAL_TERMINATION_DATE , SPRD.DATE_START)) ELSE  TRUNC(MONTHS_BETWEEN(DWD.CALENDAR_DATE , SPRD.DATE_START)) END AS TENURE_IN_MONTHS, 
 CASE WHEN EVT_HELP.PROMOTION_EVENT_IND = 1 THEN TRUNC(DWD.CALENDAR_DATE - EVT_HELP.PROMOTION_DATE) ELSE NULL END AS DAYS_SINCE_LATEST_PROMOTION, 
  CASE WHEN (RATE.ANNUALIZATION_FACTOR * RATE_VAL.MID_VALUE)>0 THEN ROUND((BASIS.SALARY_ANNUALIZATION_FACTOR *  SAL.SALARY_AMOUNT)/ (RATE.ANNUALIZATION_FACTOR * RATE_VAL.MID_VALUE),2) ELSE NULL END AS COMPUTED_COMPA_RATIO, 
  NULL AS ANNUALIZED_SALARY , 
 BASIS.SALARY_ANNUALIZATION_FACTOR * SAL.SALARY_AMOUNT AS COMPUTED_ANNUALIZED_SALARY, 
 COALESCE(SAL.CURRENCY_CODE,'~NOVALUE~') AS CURRENCY_CODE, 
 ASG_FTF.FTE AS FTE, 
 ASG_HDF.HEADCOUNT AS HEADCOUNT, 
  COALESCE(ASGF.FULL_PART_TIME_FLAG,'~NOVALUE~') AS FULL_PART_TIME_FLAG , 
  ASGF.PERMANENT_TEMPORARY_FLAG AS PERMANENT_TEMPORARY_FLAG 
 FROM  {{ ref('DW_DAY_D') }} DAY_END INNER JOIN {{ ref('DW_OBJECT_LAST_LOAD_DATE') }} INRD  ON 1=1 AND INRD.OBJECT_NAME='DW_WRKFRC_ASG_SNAPSHOT_F' AND DAY_END.CURRENT_CAL_DAY_CODE= 'CURRENT'  INNER JOIN  {{ ref('DW_DAY_D') }} DWD  ON 1=1  AND DWD.CALENDAR_DATE < DAY_END.CALENDAR_DATE AND DWD.CALENDAR_DATE>=INRD.LAST_LOAD_DATE  INNER JOIN   {{ ref('DW_WRKFRC_ASG_F') }} ASGF  ON DWD.CALENDAR_DATE>= ASGF.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE<=ASGF.EFFECTIVE_END_DATE AND ASGF.EFFECTIVE_LATEST_CHANGE='Y'  AND ASGF.PER_SYSTEM_STATUS NOT IN ('INACTIVE','INACTIVE_PAY','TERM_ASSIGN')  LEFT OUTER JOIN   {{ ref('DW_WRKFRC_ASG_FTE_F') }} ASG_FTF  ON ASGF.ASSIGNMENT_ID=ASG_FTF.ASSIGNMENT_ID AND DWD.CALENDAR_DATE>= ASG_FTF.EFFECTIVE_START_DATE AND 				  		DWD.CALENDAR_DATE<=ASG_FTF.EFFECTIVE_END_DATE  LEFT OUTER JOIN  {{ ref('DW_WRKFRC_ASG_HEADCOUNT_F') }} ASG_HDF  ON ASGF.ASSIGNMENT_ID=ASG_HDF.ASSIGNMENT_ID AND DWD.CALENDAR_DATE>= ASG_HDF.EFFECTIVE_START_DATE AND 	DWD.CALENDAR_DATE<=ASG_HDF.EFFECTIVE_END_DATE  LEFT OUTER JOIN  {{ ref('DW_WRKFRC_ASG_SUPERVISOR_F') }} ASG_SUPF  ON ASGF.ASSIGNMENT_ID=ASG_SUPF.ASSIGNMENT_ID AND DWD.CALENDAR_DATE>= ASG_SUPF.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE<=ASG_SUPF.EFFECTIVE_END_DATE  LEFT OUTER JOIN  {{ ref('DW_CMP_ASG_SALARY_F') }} SAL  ON ASGF.ASSIGNMENT_ID=SAL.ASSIGNMENT_ID AND DWD.CALENDAR_DATE>= SAL.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE<=SAL.EFFECTIVE_END_DATE  INNER JOIN   {{ ref('DW_SERVICE_PERIOD_D') }} SPRD  ON ASGF.PERIOD_OF_SERVICE_ID = SPRD.PERIOD_OF_SERVICE_ID  INNER JOIN   {{ ref('DW_JOB_D') }} JOB  ON ASGF.JOB_ID = JOB.JOB_ID AND DWD.CALENDAR_DATE >= JOB.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE<=JOB.EFFECTIVE_END_DATE  LEFT OUTER JOIN   {{ ref('DW_SALARY_BASIS_D') }} BASIS  ON SAL.SALARY_BASIS_ID = BASIS.SALARY_BASIS_ID  LEFT OUTER JOIN   {{ ref('DW_GRADE_RATE_VALUE_D') }} RATE_VAL  ON BASIS.GRADE_RATE_ID = RATE_VAL.RATE_ID AND ASGF.GRADE_ID = RATE_VAL.RATE_OBJECT_ID AND DWD.CALENDAR_DATE >=  RATE_VAL.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE <= RATE_VAL.EFFECTIVE_END_DATE AND RATE_VAL.RATE_OBJECT_TYPE = 'GRADE'  LEFT OUTER JOIN   {{ ref('DW_GRADE_RATE_D') }} RATE  ON RATE_VAL.RATE_ID = RATE.RATE_ID AND DWD.CALENDAR_DATE >=  RATE.EFFECTIVE_START_DATE AND DWD.CALENDAR_DATE <= RATE.EFFECTIVE_END_DATE  INNER JOIN   {{ ref('DW_PERSON_LEGISLATION_ALL_D') }} PER_LEG  ON ASGF.PERSON_ID = PER_LEG.PERSON_ID AND ASGF.LEGISLATION_CODE = PER_LEG.LEGISLATION_CODE AND DWD.CALENDAR_DATE >= PER_LEG.DATE_FROM AND DWD.CALENDAR_DATE<= PER_LEG.DATE_TO  INNER JOIN  {{ ref('DW_WORKER_LOCATION_D') }} LOC  ON ASGF.LOCATION_ID = LOC.LOCATION_ID  LEFT OUTER JOIN  {{ ref('DW_WRKFRC_ASG_EVENT_H') }} EVT_HELP  ON ( ASGF.ASSIGNMENT_ID = EVT_HELP.ASSIGNMENT_ID AND  DWD.CALENDAR_DATE > EVT_HELP.PROMOTION_DATE AND  DWD.CALENDAR_DATE <= EVT_HELP.NEXT_PROMOTION_DATE )  LEFT OUTER JOIN  {{ ref('DW_ASG_MANAGER_STATUS_D') }} MGR_STAT  ON (ASGF.ASSIGNMENT_ID = MGR_STAT.MANAGER_ASSIGNMENT_ID AND DWD.CALENDAR_DATE >= MGR_STAT.DATE_FROM AND DWD.CALENDAR_DATE <=MGR_STAT.DATE_TO  AND MGR_STAT.MANAGER_TYPE = 'LINE_MANAGER' AND MGR_STAT.MANAGER_FLAG = 'Y' AND MGR_STAT.PRIMARY_FLAG = 'Y' )  LEFT OUTER JOIN  {{ ref('DW_PERSON_POTENTIAL_F') }} POT  ON ASGF.PERSON_ID = POT.PERSON_ID AND DWD.CALENDAR_DATE >= POT.DATE_FROM AND DWD.CALENDAR_DATE <=POT.DATE_TO  LEFT OUTER JOIN  {{ ref('DW_PERSON_PERFORMANCE_F') }} PERF  ON ASGF.PERSON_ID = PERF.PERSON_ID AND DWD.CALENDAR_DATE >= PERF.DATE_FROM AND DWD.CALENDAR_DATE <=PERF.DATE_TO 

